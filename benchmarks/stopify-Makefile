# Add a new stopify transform here. The name should correspond to the flag
# used by the stopify binary.
TRANSFORMS = yield cps

# Get all the javascript files for benchmarking here.
FILES = $(wildcard *.js)

# All the files that will be generated.
OBJS = $(foreach tr, $(TRANSFORMS), \
			   $(foreach file, $(FILES), $(tr)/$(file)))

BASE = './base'

# $(1) is the name of the transform
define dir_TEMPLATE
$(1):
	mkdir -p $(1)
endef

# $(1) is the name of the transform
define stopify_TEMPLATE
$(1)/%.js: %.js | $(1)
	stopify -i $$< -t $(1) > $$@
endef

.PHONY: all move-to-base
all: move-to-base

# Move all files into base directory
move-to-base: | base
ifneq "$(FILES)" ""
	mv $(FILES) $(BASE)
endif

base: $(OBJS)
	mkdir -p $(BASE)

# Build rules to create directory for each transform
$(foreach tr,$(TRANSFORMS), $(eval $(call dir_TEMPLATE,$(tr))))

# Build stopify runner rules for each transform.
$(foreach tr,$(TRANSFORMS), $(eval $(call stopify_TEMPLATE,$(tr))))

# Rule to debug variables.
print-%  : ; @echo $* = $($*)
